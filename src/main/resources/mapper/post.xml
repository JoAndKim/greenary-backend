<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.joandkim.greenery.mapper.PostMapper">
    <resultMap id="BriefPostResultMap" type="com.joandkim.greenery.dto.post.BriefPost">
        <id property="id" column="id"/>
        <collection property="briefMember" column="id" select="selectBriefMemberByPostId"/>
    </resultMap>

    <resultMap id="PostDetailResultMap" type="com.joandkim.greenery.dto.post.detail.PostDetail">
        <id property="id" column="id"/>
        <collection property="briefMember" column="id" select="selectBriefMemberByPostId"/>
        <collection property="postContents" column="id" select="selectPostContentListByPostId"/>
    </resultMap>

    <select id="findAll" resultType="Post">
        SELECT *
        FROM post
    </select>

    <select id="getBriefPost" resultType="com.joandkim.greenery.dto.post.BriefPost" resultMap="BriefPostResultMap">
        # TODO: decide main post_image_url
        SELECT p.id,
        p.title,
        p.hits,
        p.like_numbers AS likes,
        (SELECT post_image_url FROM post_content WHERE post_id = p.id LIMIT 1) AS mainImageUrl
        FROM post p
        <if test="forMain == true">
            ORDER BY p.hits DESC LIMIT 3
        </if>
    </select>

    <select id="selectBriefMemberByPostId" resultType="com.joandkim.greenery.dto.post.BriefMember">
        SELECT m.id AS memberId,
               m.username,
               m.profile_image_url
        FROM `greenery`.member m
                 JOIN post p ON m.id = p.member_id
        WHERE p.id = #{id}
    </select>

    <select id="getPostDetail" resultType="com.joandkim.greenery.dto.post.detail.PostDetail"
            resultMap="PostDetailResultMap">
        SELECT p.id,
               p.title,
               p.hits,
               p.like_numbers AS likes,
               p.reg_date
        FROM post p
        WHERE p.id = #{postId}
    </select>

    <select id="selectPostContentListByPostId" resultType="com.joandkim.greenery.vo.PostContent">
        SELECT id, post_image_url, content
        FROM post_content
        WHERE post_id = #{id}
    </select>
</mapper>
